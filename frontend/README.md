# Anki Interview Frontend

Next.js frontend application for the Anki Interview App.

## Overview

A single-page application for spaced repetition study sessions with interview questions.

## Features

- **Authentication**: Google OAuth 2.0 with JWT-based session management
- **Study Flow**: Spaced repetition interface for reviewing questions
- **Question Management**: Browse and manage interview questions
- **GitHub Sync**: Import questions from GitHub repositories

## Technology Stack

- **Framework**: Next.js 15 (App Router)
- **UI**: React 18 with Tailwind CSS
- **Authentication**: Google OAuth 2.0 + JWT (jose library)
- **Deployment**: Cloudflare Workers via OpenNext.js

## Development

```bash
# Install dependencies
pnpm install

# Run development server
pnpm dev

# Build for production
pnpm build

# Preview OpenNext.js build locally
pnpm preview

# Deploy to Cloudflare Workers
pnpm deploy
```

The app will be available at `http://localhost:3000`.

## Environment Variables

Create a `.env.local` file:

```env
# Google OAuth
NEXT_PUBLIC_GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# Session configuration
SESSION_SECRET=your-super-secret-jwt-signing-key-min-32-chars
SESSION_COOKIE_NAME=anki_session
SESSION_MAX_AGE=604800  # 7 days in seconds
```

### Google OAuth Setup

1. Create a project in [Google Cloud Console](https://console.cloud.google.com/)
2. Enable Google+ API
3. Create OAuth 2.0 credentials
4. Add authorized redirect URI: `http://localhost:3000/api/auth/callback/google` (development)
5. Add production redirect URI: `https://your-domain.com/api/auth/callback/google`
6. Copy Client ID and Client Secret to environment variables

## Project Structure

```
src/
├── app/              # Next.js App Router pages
│   ├── api/         # API routes (login, logout, session)
│   ├── login/       # Login page
│   ├── study/       # Study interface
│   ├── layout.tsx   # Root layout
│   └── page.tsx     # Home page (redirects to /study)
├── components/      # React components
│   └── LogoutButton.tsx
├── lib/            # Utility libraries
│   ├── google-oauth.ts  # Google OAuth utilities
│   ├── users.ts    # User management
│   └── session.ts  # Session management
└── middleware.ts   # Route protection middleware
```

## Authentication

The app uses Google OAuth 2.0 authentication with the following flow:

1. User clicks "Sign in with Google" at `/login`
2. User is redirected to Google OAuth consent screen
3. After consent, Google redirects back with authorization code
4. Backend exchanges code for tokens and creates user account (if new)
5. JWT session token created and stored in HTTP-only cookie
6. Middleware protects all routes except `/login` and OAuth callback
7. Session expires after 7 days (configurable)

## Deployment

This frontend is deployed to Cloudflare Workers using [OpenNext.js](https://opennext.js.org/), which adapts Next.js applications for edge runtime environments.

### Prerequisites

1. Install Wrangler CLI globally (if not already installed):

```bash
pnpm add -g wrangler
```

2. Authenticate with Cloudflare:

```bash
wrangler login
```

### Build and Deploy

Deploy to Cloudflare Workers:

```bash
# Build and deploy in one command
pnpm deploy
```

Or build and preview locally first:

```bash
# Build and preview locally
pnpm preview
```

The build process will:

1. Build your Next.js application
2. Adapt it for Cloudflare Workers using OpenNext.js
3. Generate the worker bundle in `.open-next/` directory
4. Deploy to Cloudflare Workers (or start local preview server)

### Configuration

The deployment is configured via `wrangler.toml`:

- **Main entry**: `.open-next/worker.js` (generated by OpenNext.js)
- **Assets**: Served from `.open-next/assets` directory
- **Environment variables**: Set via `wrangler secret put` or in `wrangler.toml` under `[vars]`

### Environment Variables

**Yes, you can use `process.env` in your code!** OpenNext.js with Cloudflare adapter automatically polyfills `process.env` to work with Cloudflare Workers environment variables. Your existing code using `process.env.VARIABLE_NAME` will work without any changes.

#### Setting Environment Variables

**Secrets** (sensitive values like API keys) should be set via Wrangler CLI:

```bash
wrangler secret put GOOGLE_CLIENT_ID
wrangler secret put GOOGLE_CLIENT_SECRET
wrangler secret put SESSION_SECRET
```

These will be available in your code as `process.env.GOOGLE_CLIENT_ID`, `process.env.GOOGLE_CLIENT_SECRET`, and `process.env.SESSION_SECRET`.

**Public variables** (non-sensitive configuration) can be set in `wrangler.toml` under `[vars]`:

```toml
[vars]
NEXT_PUBLIC_GOOGLE_CLIENT_ID = "your-client-id"
SESSION_COOKIE_NAME = "anki_session"
SESSION_MAX_AGE = "604800"
NEXT_PUBLIC_BACKEND_URL = "https://your-backend.workers.dev"
```

These will also be available via `process.env` (e.g., `process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID`).

#### How It Works

- OpenNext.js automatically maps Cloudflare Workers environment variables to `process.env`
- The `nodejs_compat` flag in `wrangler.toml` enables Node.js compatibility
- No code changes needed - your existing `process.env` usage will work as-is
- Variables are available in both server-side code (API routes, server components) and client-side code (for `NEXT_PUBLIC_*` variables)

### OpenNext.js Configuration

The OpenNext.js configuration is in `open-next.config.ts`:

```typescript
import { defineCloudflareConfig } from "@opennextjs/cloudflare";

export default defineCloudflareConfig();
```

This uses the default Cloudflare adapter configuration. For custom settings, see the [OpenNext.js documentation](https://opennext.js.org/).
