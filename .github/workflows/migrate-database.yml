name: Database Migrations

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to run migrations on"
        required: true
        type: choice
        options:
          - dev
          - production
          - local
        default: "dev"
      dry_run:
        description: "Dry run - only check migration status without applying"
        required: false
        type: boolean
        default: false

jobs:
  migrate:
    name: Run Database Migrations
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: List available migrations
        run: |
          echo "ðŸ“ Available migration files:"
          ls -la db/migrations/

      - name: Check current migration status
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ“‹ Current migration status for ${{ inputs.environment }}:"
          if [ "${{ inputs.environment }}" = "production" ]; then
            npx wrangler d1 migrations list anki-interview-db-prod --remote || echo "âš ï¸ No migrations applied yet"
          elif [ "${{ inputs.environment }}" = "dev" ]; then
            npx wrangler d1 migrations list anki-interview-db --remote || echo "âš ï¸ No migrations applied yet"
          else
            npx wrangler d1 migrations list anki-interview-db --local || echo "âš ï¸ No migrations applied yet"
          fi

      - name: Apply migrations
        if: ${{ inputs.dry_run == false }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸš€ Applying migrations to ${{ inputs.environment }}..."
          if [ "${{ inputs.environment }}" = "production" ]; then
            pnpm db:migrate:prod
          elif [ "${{ inputs.environment }}" = "dev" ]; then
            pnpm db:migrate:dev
          else
            pnpm db:migrate
          fi
          echo "âœ… Migrations applied successfully!"

      - name: Verify migration status
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "âœ”ï¸ Final migration status:"
          if [ "${{ inputs.environment }}" = "production" ]; then
            npx wrangler d1 migrations list anki-interview-db-prod --remote
          elif [ "${{ inputs.environment }}" = "dev" ]; then
            npx wrangler d1 migrations list anki-interview-db --remote
          else
            npx wrangler d1 migrations list anki-interview-db --local
          fi

      - name: Migration summary
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "### ðŸ” Migration Dry Run Complete" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Database Migrations Applied" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Migration Status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.environment }}" = "production" ]; then
            npx wrangler d1 migrations list anki-interview-db-prod --remote >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No migrations" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ inputs.environment }}" = "dev" ]; then
            npx wrangler d1 migrations list anki-interview-db --remote >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No migrations" >> $GITHUB_STEP_SUMMARY
          else
            npx wrangler d1 migrations list anki-interview-db --local >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No migrations" >> $GITHUB_STEP_SUMMARY
          fi
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Available Migrations" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -1 db/migrations/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
